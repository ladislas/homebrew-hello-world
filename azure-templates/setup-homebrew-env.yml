# File: azure-templates/setup-homebrew-env.yml

steps:

  - bash: |
      set -e
      sudo xcode-select --switch /Applications/$(xcode_version).app/Contents/Developer
      brew update-reset /usr/local/Homebrew
    displayName: Setup homebrew

  - bash: |
      brew tap --full $(test_bot_repo)
      cp -r $(brew_tap_path)/$(test_bot_repo) $(brew_tap_path)/$(test_bot_homebrew_repo)
      git -C $(brew_tap_path)/$(test_bot_homebrew_repo) checkout -b $(test_bot_repo_branch) origin/$(test_bot_repo_branch)
    displayName: Tap $(test_bot_repo) for development purposes

  - bash: |
      HOMEBREW_TAP_DIR="/usr/local/Homebrew/Library/Taps/$(github_user)/$(github_repo)"
      mkdir -p "$HOMEBREW_TAP_DIR"
      rm -rf "$HOMEBREW_TAP_DIR"
      ln -s "$PWD" "$HOMEBREW_TAP_DIR"
    displayName: Install tap

  - bash: |
      git log --graph --decorate --oneline
      git checkout $(System.PullRequest.SourceBranch)
      git log --graph --decorate --oneline
    displayName: Checkout PR source branch $(System.PullRequest.SourceBranch)