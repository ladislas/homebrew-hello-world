# File: templates/brew_test_bot.yml

parameters:
  name: ''
  displayName: ''
  vmImage: ''

jobs:

- job: ${{ parameters.name }}
  displayName: "${{ parameters.displayName }}"

  pool:
    vmImage: ${{ parameters.vmImage }}

  dependsOn: []

  variables:
    artifact_name: ${{ parameters.vmImage }}
    artifact_json: $(artifact_name).bottle.json
    artifact_bottle: $(artifact_name).bottle.tar.gz

  steps:
    - bash: |
        echo "Install SSH Key"
      displayName: Install SSH Key

    - bash: |
        echo "Running brew test-bot"
        sw_vers > $(artifact_json)
        touch $(artifact_bottle)
      displayName: Run brew test-bot

    - bash: |
        cp *.bottle.* $(Build.ArtifactStagingDirectory)
      displayName: Copy json & bottle files

    - task: PublishPipelineArtifact@0
      inputs:
        artifactName: $(artifact_prefix)-$(artifact_name)
        targetPath: $(Build.ArtifactStagingDirectory)
      displayName: Publish $(artifact_prefix)-$(artifact_name)

    # - bash: |
    #     set -e
    #     sudo xcode-select --switch /Applications/Xcode_10.1.app/Contents/Developer
    #     brew update
    #     HOMEBREW_TAP_DIR="/usr/local/Homebrew/Library/Taps/ladislas/homebrew-hello-world"
    #     mkdir -p "$HOMEBREW_TAP_DIR"
    #     rm -rf "$HOMEBREW_TAP_DIR"
    #     ln -s "$PWD" "$HOMEBREW_TAP_DIR"
    #     brew test-bot $(package)
    #   displayName: Run brew test-bot